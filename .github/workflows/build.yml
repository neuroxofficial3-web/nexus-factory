name: Generate Final APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Python Environment
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      # Step 1: Run AI Factory with Correct API Key Mapping
      - name: Execute AI Factory Agents
        env:
          GROQ_API_KEY: ${{ secrets.LLAMA_API_KEY }} # Correctly mapping secret to Groq variable
          LLAMA_API_KEY: ${{ secrets.LLAMA_API_KEY }} # Backup for script compatibility
        run: |
          pip install requests
          python main.py  # This generates main_final.py and requirements.txt

      # Step 2: Prepare the environment for Android Build
      - name: Prepare Build Environment
        run: |
          # Move the audited final code to main.py
          if [ -f main_final.py ]; then
            mv main_final.py main.py
          fi
          
          # Initialize Buildozer
          pip install buildozer
          if [ ! -f buildozer.spec ]; then
            buildozer init
          fi

      # Step 3: Inject Requirements & Permissions (Automated Configuration)
      - name: Inject Requirements & Permissions
        run: |
          # Extract AI-generated requirements and inject into buildozer.spec
          if [ -f requirements.txt ]; then
            REQS=$(cat requirements.txt | tr '\n' ',' | sed 's/,$//')
            sed -i "s/^requirements = .*/requirements = python3,kivy,kivymd,$REQS/" buildozer.spec
          fi
          
          # Set Mandatory Android Permissions
          sed -i 's/^# android.permissions = .*/android.permissions = INTERNET, READ_EXTERNAL_STORAGE, WRITE_EXTERNAL_STORAGE/' buildozer.spec
          
          # Set App Title and Package Metadata
          sed -i 's/^title = .*/title = Nexus AI Factory/' buildozer.spec
          sed -i 's/^package.name = .*/package.name = nexus_ai_factory/' buildozer.spec

      # Step 4: Compile the Android APK
      - name: Compile Android APK (Debug)
        uses: ArtemSerebriakov/buildozer-action@v1
        with:
          command: buildozer android debug
          repository_root: .

      # Step 5: Upload the final APK for Download
      - name: Deploy APK Artifact
        uses: actions/upload-artifact@v3
        with:
          name: Mufadul-Ajlan-AI-App
          path: bin/*.apk
